{% extends "base.html" %}
{% block content %}
<section class="card" style="margin-top: 1rem;">
  <h2>Signal Status</h2>
  {% if signal_status %}
    <p><strong>Pending/Resting/Sent/Simulated:</strong>
      {{ (signal_status.counts.pending or 0)
         + (signal_status.counts.resting or 0)
         + (signal_status.counts.sent or 0)
         + (signal_status.counts.simulated or 0) }}</p>
    <p><strong>Resting orders:</strong> {{ signal_status.counts.resting or 0 }} (est. risk ${{ "%.2f"|format(signal_status.resting_risk or 0) }}, est. cost ${{ "%.2f"|format(signal_status.open_order_cost or 0) }})</p>
    <p><strong>Executed:</strong> {{ signal_status.counts.executed or 0 }}</p>
    <p><strong>Ignored:</strong> {{ signal_status.counts.ignored or 0 }}</p>
    <p><strong>Errors:</strong> {{ signal_status.counts.error or 0 }}</p>
    {% if signal_status.message %}
      <p style="color: #c00;">{{ signal_status.message }}</p>
    {% endif %}
    <div style="margin-top:8px;">
      <button onclick="cancelOpenSignals()">Cancel Open Signals</button>
      <button onclick="generateSignals()">Generate Signals</button>
      <button onclick="executeSignals()">Execute Signals</button>
      <button onclick="resetBudget()">Reset Budget</button>
    </div>
  {% else %}
    <p>No signal data yet.</p>
  {% endif %}
</section>

<section class="card" style="margin-top: 1rem;">
  <h2>Risk In Play</h2>
  {% if exposure %}
    <p><strong>Total exposure:</strong> ${{ "%.2f"|format(exposure.total_exposure or 0) }}</p>
    <p><strong>Open positions:</strong> ${{ "%.2f"|format(exposure.positions_exposure or 0) }}</p>
    <p><strong>Open signals:</strong> ${{ "%.2f"|format(exposure.signals_exposure or 0) }}</p>
  {% else %}
    <p>No exposure data available.</p>
  {% endif %}
</section>

<section class="card" style="margin-top: 1rem;">
  <h2>Threshold Performance</h2>
  {% if thresholds %}
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th style="text-align: left; padding: 4px;">Threshold</th>
        <th style="text-align: left; padding: 4px;">Direction</th>
        <th style="text-align: left; padding: 4px;">Trades</th>
        <th style="text-align: left; padding: 4px;">Win Rate</th>
        <th style="text-align: left; padding: 4px;">Avg Profit</th>
        <th style="text-align: left; padding: 4px;">Total Profit</th>
      </tr>
    </thead>
    <tbody>
      {% for name, result in thresholds.items() %}
      <tr>
        <td style="padding: 4px;">{{ result.params.threshold }}</td>
        <td style="padding: 4px; text-transform: uppercase;">{{ result.params.direction }}</td>
        <td style="padding: 4px;">{{ result.num_trades }}</td>
        <td style="padding: 4px;">{{ "%.2f"|format(result.win_rate * 100) }}%</td>
        <td style="padding: 4px;">{{ "%.4f"|format(result.average_profit) }}</td>
        <td style="padding: 4px;">{{ "%.4f"|format(result.total_profit) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No threshold results yet. Run the scheduler to populate data.</p>
  {% endif %}
</section>
<section class="chart-container">
  <h2>Calibration <small>(Samples: <span id="calibration-count">--</span>)</small></h2>
  <canvas id="calibrationChart"></canvas>
  <p id="calibration-error" style="color: red; display: none;">Error loading calibration data.</p>
</section>

<section class="card" style="margin-top: 1rem;">
  <h2>Portfolio Exposure</h2>
  {% if positions %}
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th style="text-align:left;padding:4px;">Market</th>
        <th style="text-align:left;padding:4px;">Side</th>
        <th style="text-align:left;padding:4px;">Size</th>
        <th style="text-align:left;padding:4px;">Avg Entry</th>
        <th style="text-align:left;padding:4px;">Realized PnL</th>
        <th style="text-align:left;padding:4px;">Category</th>
        <th style="text-align:left;padding:4px;">Expiry</th>
      </tr>
    </thead>
    <tbody>
      {% for pos in positions %}
      <tr>
        <td style="padding:4px;">{{ pos.market_ticker }}</td>
        <td style="padding:4px;">{{ pos.side }}</td>
        <td style="padding:4px;">{{ pos.size }}</td>
        <td style="padding:4px;">{{ "%.4f"|format(pos.avg_entry_price) }}</td>
        <td style="padding:4px;">{{ "%.4f"|format(pos.realized_pnl) }}</td>
        <td style="padding:4px;">{{ pos.category or "" }}</td>
        <td style="padding:4px;">{{ pos.expiration_ts or "" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No positions tracked yet.</p>
  {% endif %}
</section>

<section class="card" style="margin-top: 1rem;">
  <h2>Equity Curve</h2>
  <canvas id="pnlChart"></canvas>
  <p id="pnl-error" style="color:red; display:none;">Error loading PnL data.</p>
</section>

<section class="card" style="margin-top: 1rem;">
  <h2>Recent Trades</h2>
  {% if trades %}
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th style="text-align:left;padding:4px;">Time</th>
        <th style="text-align:left;padding:4px;">Market</th>
        <th style="text-align:left;padding:4px;">Side</th>
        <th style="text-align:left;padding:4px;">Dir</th>
        <th style="text-align:left;padding:4px;">Size</th>
        <th style="text-align:left;padding:4px;">Price</th>
      </tr>
    </thead>
    <tbody>
      {% for t in trades %}
      <tr>
        <td style="padding:4px;">{{ t.executed_at }}</td>
        <td style="padding:4px;">{{ t.market_ticker }}</td>
        <td style="padding:4px;">{{ t.side }}</td>
        <td style="padding:4px;">{{ t.direction }}</td>
        <td style="padding:4px;">{{ t.size }}</td>
        <td style="padding:4px;">{{ "%.4f"|format(t.price) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No trades recorded yet.</p>
  {% endif %}
</section>

<section class="card" style="margin-top: 1rem;">
  <h2>Recent Signals</h2>
  {% if signals %}
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th style="text-align: left; padding: 4px;">Time</th>
        <th style="text-align: left; padding: 4px;">Market</th>
        <th style="text-align: left; padding: 4px;">Side</th>
        <th style="text-align: right; padding: 4px;">p_mkt</th>
        <th style="text-align: right; padding: 4px;">p_true</th>
        <th style="text-align: right; padding: 4px;">EV</th>
        <th style="text-align: right; padding: 4px;">Size</th>
        <th style="text-align: left; padding: 4px;">Status</th>
        <th style="text-align: left; padding: 4px;">Exec mode</th>
        <th style="text-align: left; padding: 4px;">Error</th>
      </tr>
    </thead>
    <tbody id="signals-body">
      {% for sig in signals %}
      {% set ev = sig.expected_value %}
      {% set ev_class = '' %}
      {% if ev > 0 %}
        {% set ev_class = 'text-success' %}
      {% elif ev < 0 %}
        {% set ev_class = 'text-danger' %}
      {% endif %}
      {% set status_label = (sig.status or '').lower() %}
      {% if status_label == 'executed' %}
        {% set status_class = 'tag tag-live' %}
      {% elif status_label == 'resting' %}
        {% set status_class = 'tag' %}
      {% elif status_label in ['ignored','error'] %}
        {% set status_class = 'tag text-danger' %}
      {% else %}
        {% set status_class = 'tag' %}
      {% endif %}
      {% set exec_label = (sig.execution_mode or '').lower() %}
      {% if exec_label == 'live' %}
        {% set exec_class = 'tag tag-live' %}
      {% else %}
        {% set exec_class = 'tag' %}
      {% endif %}
      {% set ts = sig.created_at %}
      {% set ts_str = ts.strftime('%Y-%m-%d %H:%M') if ts is not none else '' %}
      {% set title_text = "Category: %s • Expiry: %s • Rule: %s • Order: %s • Exec: %s" % (
        sig.category or "",
        sig.expiry_bucket or "",
        sig.rule or "",
        sig.order_id or "",
        sig.executed_price if sig.executed_price is not none else ""
      ) %}
      <tr
        data-category="{{ sig.category or '' }}"
        data-expiry="{{ sig.expiry_bucket or '' }}"
        data-rule="{{ sig.rule or '' }}"
        data-order-id="{{ sig.order_id or '' }}"
        data-exec-price="{{ sig.executed_price if sig.executed_price is not none else '' }}"
        title="{{ title_text }}"
      >
        <td style="padding: 4px;" title="{{ sig.created_at }}">{{ ts_str }}</td>
        <td style="padding: 4px;">{{ sig.market_ticker }}</td>
        <td style="padding: 4px;">{{ (sig.side or '').upper() }}</td>
        <td style="padding: 4px; text-align:right;">{{ "%.3f"|format(sig.p_mkt) }}</td>
        <td style="padding: 4px; text-align:right;">{{ "%.3f"|format(sig.p_true_est) }}</td>
        <td style="padding: 4px; text-align:right;" class="{{ ev_class }}">{{ "%.4f"|format(ev) }}</td>
        <td style="padding: 4px; text-align:right;">{{ sig.size }}</td>
        <td style="padding: 4px;"><span class="{{ status_class }}">{{ (sig.status or '').capitalize() }}</span></td>
        <td style="padding: 4px;"><span class="{{ exec_class }}">{{ (sig.execution_mode or '').capitalize() }}</span></td>
        <td style="padding: 4px;">{{ sig.last_error or "" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No signals yet. Run the scheduler to populate data.</p>
  {% endif %}
  <p id="signals-error" style="color:red; display:none;">Error loading signals.</p>
</section>
<script>
  async function loadCalibration() {
    try {
      const res = await fetch('/calibration');
      if (!res.ok) throw new Error('Failed to load calibration');
      const buckets = await res.json();
      const totalSamples = buckets.reduce((acc, b) => acc + (b.n || 0), 0);
      const countEl = document.getElementById('calibration-count');
      if (countEl) countEl.textContent = totalSamples;
      const xs = buckets.map(b => (b.bucket_low + b.bucket_high) / 2);
      const ys = buckets.map(b => b.p_true ?? 0);
      const perfect = xs;

      const ctx = document.getElementById('calibrationChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: xs,
          datasets: [
            {
              label: 'Observed',
              data: ys,
              borderColor: 'rgba(54, 162, 235, 1)',
              backgroundColor: 'rgba(54, 162, 235, 0.2)',
              fill: false,
            },
            {
              label: 'Perfect calibration',
              data: perfect,
              borderColor: 'rgba(200, 200, 200, 1)',
              borderDash: [5, 5],
              fill: false,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: { title: { display: true, text: 'Market-implied probability' } },
            y: { title: { display: true, text: 'Empirical YES frequency' }, min: 0, max: 1 },
          },
        },
      });
    } catch (err) {
      console.error(err);
      document.getElementById('calibration-error').style.display = 'block';
    }
  }

  function loadPnlChart() {
    const series = {{ pnl_series|tojson }};
    if (!series || series.length === 0) {
      document.getElementById('pnl-error').style.display = 'block';
      return;
    }
    const labels = series.map(p => p.as_of_date);
    const realized = series.map(p => p.realized_pnl);
    const unrealized = series.map(p => p.unrealized_pnl);
    const equity = series.map(p => p.total_equity);
    const ctx = document.getElementById('pnlChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Equity', data: equity, borderColor: 'rgba(75, 192, 192, 1)', fill: false },
          { label: 'Realized', data: realized, borderColor: 'rgba(54, 162, 235, 1)', borderDash: [4, 4], fill: false },
          { label: 'Unrealized', data: unrealized, borderColor: 'rgba(255, 159, 64, 1)', borderDash: [2, 6], fill: false },
        ],
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Date' } },
          y: { title: { display: true, text: 'PnL / Equity (USD)' } },
        },
      },
    });
  }

  loadCalibration();
  loadPnlChart();

  async function cancelOpenSignals() {
    try {
      const res = await fetch('/signals/cancel_open', { method: 'POST' });
      if (!res.ok) throw new Error('Failed to cancel signals');
      const data = await res.json();
      alert(`Cancelled ${data.cancelled} open signals`);
    } catch (err) {
      console.error(err);
      alert('Error cancelling signals');
    }
    window.location.reload();
  }

  async function generateSignals() {
    try {
      const res = await fetch('/admin/generate_signals', { method: 'POST' });
      if (!res.ok) throw new Error('Failed to generate signals');
      const data = await res.json();
      alert(`Generated ${data.created} signals`);
    } catch (err) {
      console.error(err);
      alert('Error generating signals');
    }
    window.location.reload();
  }

  async function executeSignals() {
    try {
      const res = await fetch('/admin/execute_signals', { method: 'POST' });
      if (!res.ok) throw new Error('Failed to execute signals');
      const data = await res.json();
      alert(`Processed ${data.processed} signals`);
    } catch (err) {
      console.error(err);
      alert('Error executing signals');
    }
    window.location.reload();
  }

  async function resetBudget() {
    try {
      const res = await fetch('/admin/reset_budget', { method: 'POST' });
      if (!res.ok) throw new Error('Failed to reset budget');
      const data = await res.json();
      alert(`Budget reset to ${data.total_equity}`);
    } catch (err) {
      console.error(err);
      alert('Error resetting budget');
    }
    window.location.reload();
  }
</script>
{% endblock %}
